---
# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: Scheduled Release

concurrency:
  group: pack-release
  cancel-in-progress: false

on:
  workflow_dispatch:
  push:
    branches:
      - main

env:
  # renovate: datasource=github-releases depName=Fabulously-Optimized/fabulously-optimized
  VERSION: v6.5.0-alpha.6

jobs:
  sync-release:
    name: Sync and Create Matching Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5

      - name: Install Packwiz
        run: go install github.com/packwiz/packwiz@latest

      - name: Download and Process Release
        id: process-release
        run: |
          # Remove the 'v' prefix from VERSION
          VERSION_STRIPPED="${VERSION#v}"

          # Download the pack zip file
          wget -O FO.zip "https://github.com/Fabulously-Optimized/fabulously-optimized/releases/download/$VERSION/Fabulously.Optimized-$VERSION_STRIPPED.zip"

          # Remove old files
          rm -r mods/ || true
          rm -r config/ || true
          rm index.toml || true
          rm pack.toml || true

          # Import the new pack
          packwiz cf import FO.zip

          # Cleanup
          rm FO.zip
          rm -r resourcepacks/ || true

          # Remove mods based on exclusion list
          curl --silent "https://raw.githubusercontent.com/itzg/docker-minecraft-server/master/files/cf-exclude-include.json" |
          jq -r '.globalExcludes[]' | while read -r mod; do
            echo "Removing $mod if exists..."
            packwiz remove "$mod" 1>/dev/null || true
          done

          # Remove e4mc mod
          packwiz remove e4mc

          # Refresh packwiz metadata
          packwiz refresh

      - name: Check for Changes
        id: changes
        run: |
          git diff --exit-code || echo "Changes detected"
        continue-on-error: true

      - name: Commit and Push Changes
        if: steps.changes.outcome == 'success'
        run: |
          git config user.name "codewarden-bot"
          git config user.email "168740723+codewarden-bot[bot]@users.noreply.github.com"
          git add .
          git commit -m "Synced with upstream release $VERSION" || echo "No changes to commit"
          git push || echo "No changes to push"

      - name: Generate Token
        if: steps.changes.outcome == 'success'
        uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: "${{ secrets.BOT_APP_ID }}"
          private-key: "${{ secrets.BOT_APP_PRIVATE_KEY }}"

      - name: Create Release
        if: steps.changes.outcome == 'success'
        uses: ncipollo/release-action@v1
        with:
          tag: "${{ env.VERSION }}"
          token: "${{ steps.app-token.outputs.token }}"
